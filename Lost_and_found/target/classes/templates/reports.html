<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout :: head('Reports Dashboard')"></head>
<body>
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">📊 Reports Dashboard</h1>
        <p class="text-muted">Track lost, found, and recovered items in real time</p>
    </div>

    <div class="row g-4 mb-5">
        <!-- Lost Items Card -->
        <div class="col-md-4">
            <div class="card border-danger shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h4><i class="bi bi-x-circle"></i> Lost Items</h4>
                </div>
                <div class="card-body">
                    <h2 class="display-6 text-danger" id="lost-count">--</h2>
                    <p class="text-muted">Items reported as missing</p>
                </div>
            </div>
        </div>

        <!-- Found Items Card -->
        <div class="col-md-4">
            <div class="card border-success shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4><i class="bi bi-check-circle"></i> Found Items</h4>
                </div>
                <div class="card-body">
                    <h2 class="display-6 text-success" id="found-count">--</h2>
                    <p class="text-muted">Items waiting to be claimed</p>
                </div>
            </div>
        </div>

        <!-- Recovered Items Card -->
        <div class="col-md-4">
            <div class="card border-warning shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h4><i class="bi bi-hand-thumbs-up"></i> Recovered</h4>
                </div>
                <div class="card-body">
                    <h2 class="display-6 text-warning" id="recovered-count">--</h2>
                    <p class="text-muted">Successfully returned items</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs for Detailed Lists -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <ul class="nav nav-tabs card-header-tabs" id="reportTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active text-white" data-bs-toggle="tab" href="#lostTab">Lost Items</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" data-bs-toggle="tab" href="#foundTab">Found Items</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" data-bs-toggle="tab" href="#recoveredTab">Recovered</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="reportTabContent">
                <!-- Lost Items Table -->
                <div class="tab-pane fade show active" id="lostTab">
                    <div id="lost-items-list"></div>
                </div>
                <!-- Found Items Table -->
                <div class="tab-pane fade" id="foundTab">
                    <div id="found-items-list"></div>
                </div>
                <!-- Recovered Items Table -->
                <div class="tab-pane fade" id="recoveredTab">
                    <div id="recovered-items-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="layout :: footer"></footer>

<script>
    // Render item table
    function renderItemTable(items, containerId) {
        const container = document.getElementById(containerId);
        if (items.length === 0) {
            container.innerHTML = `<p class="text-muted">No items found.</p>`;
            return;
        }

        let html = `
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Item</th>
                <th>Category</th>
                <th>Location</th>
                <th>Reported By</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;

        items.forEach(item => {
            html += `
          <tr>
            <td><strong>${item.name}</strong><br><small>${item.description?.substring(0, 30) || ''}</small></td>
            <td>${item.category || '—'}</td>
            <td><i class="bi bi-geo-alt"></i> ${item.location}</td>
            <td>${item.reportedBy?.name || '—'}</td>
            <td>${new Date(item.reportedAt).toLocaleDateString()}</td>
            <td>
              <span class="badge rounded-pill
                ${item.status === 'LOST' ? 'bg-danger' :
                item.status === 'FOUND' ? 'bg-success' : 'bg-warning text-dark'}">
                ${item.status}
              </span>
            </td>
            <td>
              ${item.status !== 'RECOVERED' ?
                `<button class="btn btn-sm btn-outline-primary" onclick="markAsRecovered(${item.itemId})">
                  <i class="bi bi-hand-thumbs-up"></i> Mark Recovered
                </button>` :
                `<span class="text-success">✅ Recovered</span>`
            }
            </td>
          </tr>
        `;
        });

        html += `</tbody></table></div>`;
        container.innerHTML = html;
    }

    // Mark item as recovered
    async function markAsRecovered(itemId) {
        const reporterId = prompt("Enter your User ID to confirm recovery:");
        if (!reporterId) return;
        try {
            const res = await fetch('/api/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            // Check if response is JSON before parsing
            const contentType = res.headers.get('content-type');
            let result;
            if (contentType && contentType.includes('application/json')) {
                result = await res.json();
            } else {
                // Fallback: read as text to see actual error
                const text = await res.text();
                throw new Error(`Server error (${res.status}): ${text.substring(0, 200)}...`);
            }

            if (res.ok) {
                alert('✅ Item reported successfully!');
                document.getElementById('reportForm').reset();
            } else {
                const errorMsg = result.message || 'Failed to report item';
                alert('❌ Error: ' + errorMsg);
            }
        } catch (err) {
            console.error('Submission error:', err);
            alert('❌ ' + err.message);
        }

    // Load all reports
    async function loadReports() {
        try {
            const [lostRes, foundRes, allRes] = await Promise.all([
                fetch('/api/reports/lost-items'),
                fetch('/api/reports/found-items'),
                fetch('/api/items')
            ]);

            const lost = await lostRes.json();
            const found = await foundRes.json();
            const all = await allRes.json();
            const recovered = all.filter(item => item.status === 'RECOVERED');

            document.getElementById('lost-count').textContent = lost.length;
            document.getElementById('found-count').textContent = found.length;
            document.getElementById('recovered-count').textContent = recovered.length;

            renderItemTable(lost, 'lost-items-list');
            renderItemTable(found, 'found-items-list');
            renderItemTable(recovered, 'recovered-items-list');
        } catch (err) {
            console.error("Failed to load reports:", err);
        }
    }

    // Initialize
    loadReports();
</script>

<style>
    .nav-tabs .nav-link.active {
        background: var(--primary) !important;
        color: white !important;
    }
    .table-hover tbody tr:hover {
        background-color: #f9f9ff;
    }
</style>
</body>
</html>