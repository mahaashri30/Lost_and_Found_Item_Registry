<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout :: head('Report Item')"></head>
<body>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white text-center py-4">
          <h2><i class="bi bi-plus-circle"></i> Report Lost or Found Item</h2>
        </div>
        <div class="card-body p-4">
          <form id="reportForm">
            <div class="mb-3">
              <label class="form-label">Item Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="name" placeholder="e.g., Black Wallet" required>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" id="category">
                  <option value="">Select Category</option>
                  <option value="ELECTRONICS">Electronics</option>
                  <option value="CLOTHING">Clothing</option>
                  <option value="ACCESSORIES">Accessories</option>
                  <option value="DOCUMENTS">Documents</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Status <span class="text-danger">*</span></label>
                <select class="form-select" id="status" required>
                  <option value="">Select Status</option>
                  <option value="LOST">Lost</option>
                  <option value="FOUND">Found</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Location <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="location" placeholder="e.g., Library, Cafeteria" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="description" rows="3" placeholder="Add details like color, brand, etc."></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Your User ID <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="reportedById" placeholder="Enter your user ID (register first if new)" required>
              <div class="form-text">
                Don’t have a user ID? <a href="#" data-bs-toggle="modal" data-bs-target="#userModal">Register here</a>
              </div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-send"></i> Submit Report
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- User Registration Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="userModalLabel">Register as User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <div class="mb-3">
            <input type="text" class="form-control" id="userName" placeholder="Full Name" required>
          </div>
          <div class="mb-3">
            <input type="email" class="form-control" id="userEmail" placeholder="Email" required>
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" id="userContact" placeholder="Phone (optional)">
          </div>
          <button type="submit" class="btn btn-info w-100">Register</button>
        </form>
      </div>
    </div>
  </div>
</div>

<footer th:replace="layout :: footer"></footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Report item
  document.getElementById('reportForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('name').value.trim();
    const status = document.getElementById('status').value;
    const location = document.getElementById('location').value.trim();
    const reportedById = document.getElementById('reportedById').value;

    if (!name || !status || !location || !reportedById) {
      alert('❌ Please fill all required fields.');
      return;
    }

    const data = {
      name: name,
      category: document.getElementById('category').value || null,
      description: document.getElementById('description').value || null,
      status: status,
      location: location,
      reportedById: parseInt(reportedById)
    };

    try {
      const res = await fetch('/api/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const contentType = res.headers.get('content-type');
      let result;
      if (contentType && contentType.includes('application/json')) {
        result = await res.json();
      } else {
        throw new Error(`Server error (${res.status})`);
      }

      if (res.ok) {
        alert('✅ Item reported successfully!');
        document.getElementById('reportForm').reset();
      } else {
        alert('❌ Error: ' + (result.message || 'Failed to report item'));
      }
    } catch (err) {
      console.error('Submission error:', err);
      alert('❌ Network error: ' + err.message);
    }
  });

  // Register user
  document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('userName').value.trim();
    const email = document.getElementById('userEmail').value.trim();

    if (!name || !email) {
      alert('❌ Name and email are required.');
      return;
    }

    const userData = {
      name: name,
      email: email,
      contact: document.getElementById('userContact').value || null
    };

    try {
      const res = await fetch('/api/users', { // ✅ FIXED: Correct endpoint
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });

      const contentType = res.headers.get('content-type');
      let user;
      if (contentType && contentType.includes('application/json')) {
        user = await res.json();
      } else {
        throw new Error(`Server error (${res.status})`);
      }

      if (res.ok) {
        document.getElementById('reportedById').value = user.userId;
        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        alert('✅ Registered! Your User ID: ' + user.userId);
      } else {
        alert('❌ Error: ' + (user.message || 'Registration failed'));
      }
    } catch (err) {
      console.error('Registration error:', err);
      alert('❌ Network error: ' + err.message);
    }
  });
</script>
</body>
</html>